// ==UserScript==
// @name        tryrating-userscript
// @version     1.0.1
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://crashmax-dev.github.io/tryrating-userscript/
// @match       https://www.tryrating.com/app/survey/*
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_addStyle
// @grant       GM_notification
// @updateURL   https://crashmax-dev.github.io/tryrating-userscript/tryrating-userscript.meta.js
// @downloadURL https://crashmax-dev.github.io/tryrating-userscript/tryrating-userscript.user.js
// ==/UserScript==

var __defProp=Object.defineProperty,__defNormalProp=(h,l,m)=>l in h?__defProp(h,l,{enumerable:!0,configurable:!0,writable:!0,value:m}):h[l]=m,__publicField=(h,l,m)=>(__defNormalProp(h,typeof l!="symbol"?l+"":l,m),m);(function(){"use strict";const h=t=>(e,s)=>(t.set(e,s),s),l=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,m=536870912,I=m*2,O=(t,e)=>s=>{const r=e.get(s);let n=r===void 0?s.size:r<I?r+1:0;if(!s.has(n))return t(s,n);if(s.size<m){for(;s.has(n);)n=Math.floor(Math.random()*I);return t(s,n)}if(s.size>l)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;s.has(n);)n=Math.floor(Math.random()*l);return t(s,n)},_=new WeakMap,S=h(_),y=O(S,_),N=t=>t.method!==void 0&&t.method==="call",$=t=>t.error===null&&typeof t.id=="number",C=((t,e)=>{let s=null;return()=>{if(s!==null)return s;const r=new Blob([e],{type:"application/javascript; charset=utf-8"}),n=URL.createObjectURL(r);return s=t(n),setTimeout(()=>URL.revokeObjectURL(n)),s}})(t=>{const e=new Map([[0,()=>{}]]),s=new Map([[0,()=>{}]]),r=new Map,n=new Worker(t);return n.addEventListener("message",({data:a})=>{if(N(a)){const{params:{timerId:i,timerType:o}}=a;if(o==="interval"){const c=e.get(i);if(typeof c=="number"){const d=r.get(c);if(d===void 0||d.timerId!==i||d.timerType!==o)throw new Error("The timer is in an undefined state.")}else if(typeof c<"u")c();else throw new Error("The timer is in an undefined state.")}else if(o==="timeout"){const c=s.get(i);if(typeof c=="number"){const d=r.get(c);if(d===void 0||d.timerId!==i||d.timerType!==o)throw new Error("The timer is in an undefined state.")}else if(typeof c<"u")c(),s.delete(i);else throw new Error("The timer is in an undefined state.")}}else if($(a)){const{id:i}=a,o=r.get(i);if(o===void 0)throw new Error("The timer is in an undefined state.");const{timerId:c,timerType:d}=o;r.delete(i),d==="interval"?e.delete(c):s.delete(c)}else{const{error:{message:i}}=a;throw new Error(i)}}),{clearInterval:a=>{const i=y(r);r.set(i,{timerId:a,timerType:"interval"}),e.set(a,i),n.postMessage({id:i,method:"clear",params:{timerId:a,timerType:"interval"}})},clearTimeout:a=>{const i=y(r);r.set(i,{timerId:a,timerType:"timeout"}),s.set(a,i),n.postMessage({id:i,method:"clear",params:{timerId:a,timerType:"timeout"}})},setInterval:(a,i)=>{const o=y(e);return e.set(o,()=>{a(),typeof e.get(o)=="function"&&n.postMessage({id:null,method:"set",params:{delay:i,now:performance.now(),timerId:o,timerType:"interval"}})}),n.postMessage({id:null,method:"set",params:{delay:i,now:performance.now(),timerId:o,timerType:"interval"}}),o},setTimeout:(a,i)=>{const o=y(s);return s.set(o,a),n.postMessage({id:null,method:"set",params:{delay:i,now:performance.now(),timerId:o,timerType:"timeout"}}),o}}},`(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(i=>{let{data:s}=i;try{if("clear"===s.method){const{id:r,params:{timerId:o,timerType:i}}=s;if("interval"===i)(t=>{const r=e.get(t);if(void 0===r)throw new Error('There is no interval scheduled with the given id "'.concat(t,'".'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==i)throw new Error('The given type "'.concat(i,'" is not supported'));(e=>{const r=t.get(e);if(void 0===r)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==s.method)throw new Error('The given method "'.concat(s.method,'" is not supported'));{const{params:{delay:i,now:n,timerId:a,timerType:d}}=s;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(i,a,n);else{if("timeout"!==d)throw new Error('The given type "'.concat(d,'" is not supported'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(i,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:s.id,result:null})}}))})();`),L=t=>C().clearInterval(t),F=(t,e)=>C().setInterval(t,e);function u(t,e,...s){const r=document.createElement(t);return typeof e=="string"?r.append(B(e)):Array.isArray(e)?s.unshift(...e):(Object.assign(r,e),Object.assign(r.style,e?.style)),s.length&&r.append(...s),r}function B(t){return document.createTextNode(t)}const T=1e3,g=T*60,w=g*60,f=w*24,U=f*7,q=f*365.25;function b(t,e){try{if(typeof t=="string"&&t.length>0)return W(t);if(typeof t=="number"&&isFinite(t))return e?.long?G(t):D(t);throw new Error("Value is not a string or number.")}catch(s){const r=P(s)?`${s.message}. value=${JSON.stringify(t)}`:"An unknown error has occured.";throw new Error(r)}}function W(t){if(t=String(t),t.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(t);if(!e)return NaN;const s=parseFloat(e[1]),r=(e[2]||"ms").toLowerCase();switch(r){case"years":case"year":case"yrs":case"yr":case"y":return s*q;case"weeks":case"week":case"w":return s*U;case"days":case"day":case"d":return s*f;case"hours":case"hour":case"hrs":case"hr":case"h":return s*w;case"minutes":case"minute":case"mins":case"min":case"m":return s*g;case"seconds":case"second":case"secs":case"sec":case"s":return s*T;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw new Error(`The unit ${r} was matched, but no matching case exists.`)}}function D(t){const e=Math.abs(t);return e>=f?`${Math.round(t/f)}d`:e>=w?`${Math.round(t/w)}h`:e>=g?`${Math.round(t/g)}m`:e>=T?`${Math.round(t/T)}s`:`${t}ms`}function G(t){const e=Math.abs(t);return e>=f?E(t,e,f,"day"):e>=w?E(t,e,w,"hour"):e>=g?E(t,e,g,"minute"):e>=T?E(t,e,T,"second"):`${t} ms`}function E(t,e,s,r){const n=e>=s*1.5;return`${Math.round(t/s)} ${r}${n?"s":""}`}function P(t){return typeof t=="object"&&t!==null&&"message"in t}class V{constructor(e){this.storage=e}download(){const e=this.storage.read();if(!e.length){alert("\u041D\u0435\u0442\u0443 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430.");return}const s=new Date,r=new Intl.DateTimeFormat("ru-RU",{timeZone:"UTC",timeZoneName:"short"}),n=u("table",{border:"1"}),k=u("caption"),v=u("tr",[u("th","Task Type"),u("th","Estimated Rating Time")]);n.append(k,v);let p=0;for(const{type:i,estimated:o}of e){p+=o;const c=u("tr",[u("td",i),u("td",b(o,{long:!0}))]);n.append(c)}k.textContent=`Tasks ${r.format(s)} (${b(p,{long:!0})})`;const x=new Blob([n.outerHTML],{type:"text/html"});u("a",{href:URL.createObjectURL(x),download:`tryrating-com-${s.toISOString()}.html`}).click()}}const j=".survey-meta-fields",z=".labeled-attribute__attribute",R={selector:".btn-success",text:"Submit Rating"},H=".modal-container.visible",M="tryrating-storage";function Y(){const t=[],e=Array.from(document.querySelectorAll(R.selector));for(const s of e)s instanceof HTMLButtonElement&&s.textContent===R.text&&t.push(s);return t}function K(){return document.querySelector(H)}function A(t){return t.split(/\s(?=\d)/).reduce((s,r)=>(s+=b(r),s),0)}class X{constructor(){__publicField(this,"tasks",[]),this.read(),console.log("storage",this.tasks)}get values(){return this.tasks}reset(){this.tasks=[],GM_setValue(M,this.tasks)}read(){return this.tasks=GM_getValue(M,[]),this.tasks}write(e){this.tasks.push(e),GM_setValue(M,this.tasks)}}class Z{constructor(){__publicField(this,"taskFields",null),__publicField(this,"onChangeTaskCallback",null)}get values(){return this.taskFields}onChangeTask(e){this.onChangeTaskCallback=e}watch(){var e;const s=document.querySelector(j);if(!s)return;const r=Array.from(s.querySelectorAll(z));if(!r.length)return;const[n,k,v]=r,p={taskType:n.textContent,requestId:k.textContent,estimatedRatingTime:v.textContent.trim()};p.requestId!==((e=this.taskFields)==null?void 0:e.requestId)&&this.onChangeTaskCallback(p),this.taskFields=p}}class J{constructor(){__publicField(this,"intervalId"),__publicField(this,"ms",0),__publicField(this,"onTickCallback"),__publicField(this,"onEndCallback")}onTimerTick(e){this.onTickCallback=e}onTimerEnd(e){this.onEndCallback=e}onTickTimer(){this.ms-=1e3;const e=b(this.ms,{long:!0});this.onTickCallback(e),this.ms===0&&(this.onEndCallback(),this.stop())}start(e){this.stop(),this.ms=e,this.intervalId=F(()=>this.onTickTimer(),1e3)}stop(){this.intervalId&&(L(this.intervalId),this.intervalId=null)}}class Q{constructor(e){__publicField(this,"timer"),__publicField(this,"taskCounter"),this.storage=e}init(){const e=u("div",{className:"tryrating-container"});this.taskCounter=u("span"),this.timer=u("span"),e.append(this.timer,this.taskCounter),document.body.appendChild(e),this.renderTaskCounter()}renderTime(e){this.timer.textContent=`Time: ${e}`}renderTaskCounter(){this.taskCounter.textContent=`Tasks: ${this.storage.values.length}`}}const ie="";class ee{constructor(e){__publicField(this,"backuper"),__publicField(this,"ui"),__publicField(this,"timer"),__publicField(this,"taskFieldsWatcher"),__publicField(this,"submitButtons",[]),__publicField(this,"taskFields",null),__publicField(this,"modal",null),this.storage=e}init(){this.backuper=new V(this.storage),this.ui=new Q(this.storage),this.ui.init(),this.timer=new J,this.timer.onTimerTick(e=>this.ui.renderTime(e)),this.timer.onTimerEnd(async()=>{if(!this.submitButtons.length){console.error("submitButtons is not defined");return}this.submitButtons[0].click()}),this.taskFieldsWatcher=new Z,this.taskFieldsWatcher.onChangeTask(e=>{this.taskFields&&this.taskFields.requestId!==e.requestId&&(console.info("Current task is submitted:",this.taskFields),this.writeSubmittedTask()),this.taskFields=e,this.submitButtons=Y();const s=A(this.taskFields.estimatedRatingTime);this.timer.start(s)}),F(()=>{this.taskFieldsWatcher.watch(),K()&&GM_notification({title:"\u041E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u043C\u043E\u0434\u0430\u043B\u044C\u043D\u043E\u0435 \u043E\u043A\u043D\u043E",highlight:!0,silent:!1,timeout:5e3})},5e3),window.addEventListener("keydown",e=>{e.altKey&&e.key==="1"&&(e.preventDefault(),this.backuper.download()),e.altKey&&e.key==="2"&&(e.preventDefault(),confirm(`Reset data.
Are you sure?`)&&(this.storage.reset(),this.ui.renderTaskCounter()))})}writeSubmittedTask(){this.storage.write({type:this.taskFields.taskType,estimated:A(this.taskFields.estimatedRatingTime)}),this.ui.renderTaskCounter()}}const te=new X;new ee(te).init(),GM_addStyle(".tryrating-container{display:flex;align-items:center;flex-direction:column;gap:1rem;text-align:center;position:absolute;z-index:9999999;background:#2e2c2f;font-size:1rem;font-weight:600;color:#fff;width:75px;bottom:12%;padding:4px}")})();
