// ==UserScript==
// @name        tryrating-userscript
// @version     1.1.1
// @author      crashmax <userscript@crashmax.ru>
// @license     MIT
// @homepage    https://crashmax-dev.github.io/tryrating-userscript/
// @match       https://www.tryrating.com/app/survey/*
// @grant       GM_setValue
// @grant       GM_getValue
// @grant       GM_addStyle
// @grant       GM_notification
// @updateURL   https://crashmax-dev.github.io/tryrating-userscript/tryrating-userscript.meta.js
// @downloadURL https://crashmax-dev.github.io/tryrating-userscript/tryrating-userscript.user.js
// ==/UserScript==

(function(){"use strict";const C={equals:(e,t)=>e===t};let pe=Q;const y=1,M=2,Y={owned:null,cleanups:null,context:null,owner:null};var p=null;let D=null,f=null,m=null,T=null,x=0;function ge(e,t){const s=f,n=p,r=e.length===0,i=r?Y:{owned:null,cleanups:null,context:null,owner:t===void 0?n:t},l=r?e:()=>e(()=>_(()=>O(i)));p=i,f=null;try{return v(l,!0)}finally{f=s,p=n}}function I(e,t){t=t?Object.assign({},C,t):C;const s={value:e,observers:null,observerSlots:null,comparator:t.equals||void 0},n=r=>(typeof r=="function"&&(r=r(s.value)),z(s,r));return[X.bind(s),n]}function G(e,t,s){const n=Z(e,t,!1,y);R(n)}function K(e,t,s){s=s?Object.assign({},C,s):C;const n=Z(e,t,!0,0);return n.observers=null,n.observerSlots=null,n.comparator=s.equals||void 0,R(n),X.bind(n)}function _(e){if(f===null)return e();const t=f;f=null;try{return e()}finally{f=t}}function X(){if(this.sources&&this.state)if(this.state===y)R(this);else{const e=m;m=null,v(()=>N(this),!1),m=e}if(f){const e=this.observers?this.observers.length:0;f.sources?(f.sources.push(this),f.sourceSlots.push(e)):(f.sources=[this],f.sourceSlots=[e]),this.observers?(this.observers.push(f),this.observerSlots.push(f.sources.length-1)):(this.observers=[f],this.observerSlots=[f.sources.length-1])}return this.value}function z(e,t,s){let n=e.value;return(!e.comparator||!e.comparator(n,t))&&(e.value=t,e.observers&&e.observers.length&&v(()=>{for(let r=0;r<e.observers.length;r+=1){const i=e.observers[r],l=D&&D.running;l&&D.disposed.has(i),(l?!i.tState:!i.state)&&(i.pure?m.push(i):T.push(i),i.observers&&ee(i)),l||(i.state=y)}if(m.length>1e6)throw m=[],new Error},!1)),t}function R(e){if(!e.fn)return;O(e);const t=p,s=f,n=x;f=p=e,we(e,e.value,n),f=s,p=t}function we(e,t,s){let n;try{n=e.fn(t)}catch(r){return e.pure&&(e.state=y,e.owned&&e.owned.forEach(O),e.owned=null),e.updatedAt=s+1,te(r)}(!e.updatedAt||e.updatedAt<=s)&&(e.updatedAt!=null&&"observers"in e?z(e,n):e.value=n,e.updatedAt=s)}function Z(e,t,s,n=y,r){const i={fn:e,state:n,updatedAt:null,owned:null,sources:null,sourceSlots:null,cleanups:null,value:t,owner:p,context:null,pure:s};return p===null||p!==Y&&(p.owned?p.owned.push(i):p.owned=[i]),i}function J(e){if(e.state===0)return;if(e.state===M)return N(e);if(e.suspense&&_(e.suspense.inFallback))return e.suspense.effects.push(e);const t=[e];for(;(e=e.owner)&&(!e.updatedAt||e.updatedAt<x);)e.state&&t.push(e);for(let s=t.length-1;s>=0;s--)if(e=t[s],e.state===y)R(e);else if(e.state===M){const n=m;m=null,v(()=>N(e,t[0]),!1),m=n}}function v(e,t){if(m)return e();let s=!1;t||(m=[]),T?s=!0:T=[],x++;try{const n=e();return ye(s),n}catch(n){s||(T=null),m=null,te(n)}}function ye(e){if(m&&(Q(m),m=null),e)return;const t=T;T=null,t.length&&v(()=>pe(t),!1)}function Q(e){for(let t=0;t<e.length;t++)J(e[t])}function N(e,t){e.state=0;for(let s=0;s<e.sources.length;s+=1){const n=e.sources[s];if(n.sources){const r=n.state;r===y?n!==t&&(!n.updatedAt||n.updatedAt<x)&&J(n):r===M&&N(n,t)}}}function ee(e){for(let t=0;t<e.observers.length;t+=1){const s=e.observers[t];s.state||(s.state=M,s.pure?m.push(s):T.push(s),s.observers&&ee(s))}}function O(e){let t;if(e.sources)for(;e.sources.length;){const s=e.sources.pop(),n=e.sourceSlots.pop(),r=s.observers;if(r&&r.length){const i=r.pop(),l=s.observerSlots.pop();n<r.length&&(i.sourceSlots[l]=n,r[n]=i,s.observerSlots[n]=l)}}if(e.owned){for(t=e.owned.length-1;t>=0;t--)O(e.owned[t]);e.owned=null}if(e.cleanups){for(t=e.cleanups.length-1;t>=0;t--)e.cleanups[t]();e.cleanups=null}e.state=0,e.context=null}function Te(e){return e instanceof Error?e:new Error(typeof e=="string"?e:"Unknown error",{cause:e})}function te(e,t=p){throw Te(e)}function be(e,t){return _(()=>e(t||{}))}function Ee(e,t,s){let n=s.length,r=t.length,i=n,l=0,o=0,d=t[r-1].nextSibling,u=null;for(;l<r||o<i;){if(t[l]===s[o]){l++,o++;continue}for(;t[r-1]===s[i-1];)r--,i--;if(r===l){const a=i<n?o?s[o-1].nextSibling:s[i-o]:d;for(;o<i;)e.insertBefore(s[o++],a)}else if(i===o)for(;l<r;)(!u||!u.has(t[l]))&&t[l].remove(),l++;else if(t[l]===s[i-1]&&s[o]===t[r-1]){const a=t[--r].nextSibling;e.insertBefore(s[o++],t[l++].nextSibling),e.insertBefore(s[--i],a),t[r]=s[i]}else{if(!u){u=new Map;let c=o;for(;c<i;)u.set(s[c],c++)}const a=u.get(t[l]);if(a!=null)if(o<a&&a<i){let c=l,h=1,g;for(;++c<r&&c<i&&!((g=u.get(t[c]))==null||g!==a+h);)h++;if(h>a-o){const Ze=t[l];for(;o<a;)e.insertBefore(s[o++],Ze)}else e.replaceChild(s[o++],t[l++])}else l++;else t[l++].remove()}}}function ke(e,t,s,n={}){let r;return ge(i=>{r=i,t===document?e():W(t,e(),t.firstChild?null:void 0,s)},n.owner),()=>{r(),t.textContent=""}}function Ae(e,t,s){let n;const r=()=>{const l=document.createElement("template");return l.innerHTML=e,s?l.content.firstChild.firstChild:l.content.firstChild},i=t?()=>_(()=>document.importNode(n||(n=r()),!0)):()=>(n||(n=r())).cloneNode(!0);return i.cloneNode=i,i}function W(e,t,s,n){if(s!==void 0&&!n&&(n=[]),typeof t!="function")return F(e,t,n,s);G(r=>F(e,t(),r,s),n)}function F(e,t,s,n,r){for(;typeof s=="function";)s=s();if(t===s)return s;const i=typeof t,l=n!==void 0;if(e=l&&s[0]&&s[0].parentNode||e,i==="string"||i==="number")if(i==="number"&&(t=t.toString()),l){let o=s[0];o&&o.nodeType===3?o.data=t:o=document.createTextNode(t),s=E(e,s,n,o)}else s!==""&&typeof s=="string"?s=e.firstChild.data=t:s=e.textContent=t;else if(t==null||i==="boolean")s=E(e,s,n);else{if(i==="function")return G(()=>{let o=t();for(;typeof o=="function";)o=o();s=F(e,o,s,n)}),()=>s;if(Array.isArray(t)){const o=[],d=s&&Array.isArray(s);if(j(o,t,s,r))return G(()=>s=F(e,o,s,n,!0)),()=>s;if(o.length===0){if(s=E(e,s,n),l)return s}else d?s.length===0?se(e,o,n):Ee(e,s,o):(s&&E(e),se(e,o));s=o}else if(t.nodeType){if(Array.isArray(s)){if(l)return s=E(e,s,n,t);E(e,s,null,t)}else s==null||s===""||!e.firstChild?e.appendChild(t):e.replaceChild(t,e.firstChild);s=t}else console.warn("Unrecognized value. Skipped inserting",t)}return s}function j(e,t,s,n){let r=!1;for(let i=0,l=t.length;i<l;i++){let o=t[i],d=s&&s[i],u;if(!(o==null||o===!0||o===!1))if((u=typeof o)=="object"&&o.nodeType)e.push(o);else if(Array.isArray(o))r=j(e,o,d)||r;else if(u==="function")if(n){for(;typeof o=="function";)o=o();r=j(e,Array.isArray(o)?o:[o],Array.isArray(d)?d:[d])||r}else e.push(o),r=!0;else{const a=String(o);d&&d.nodeType===3&&d.data===a?e.push(d):e.push(document.createTextNode(a))}}return r}function se(e,t,s=null){for(let n=0,r=t.length;n<r;n++)e.insertBefore(t[n],s)}function E(e,t,s,n){if(s===void 0)return e.textContent="";const r=n||document.createTextNode("");if(t.length){let i=!1;for(let l=t.length-1;l>=0;l--){const o=t[l];if(r!==o){const d=o.parentNode===e;!i&&!l?d?e.replaceChild(r,o):e.insertBefore(r,s):d&&o.remove()}else i=!0}}else e.insertBefore(r,s);return[r]}const k=1e3,A=k*60,S=A*60,b=S*24,Se=b*7,ve=b*365.25;function B(e,t){try{if(typeof e=="string"&&e.length>0)return Ce(e);if(typeof e=="number"&&isFinite(e))return t?.long?xe(e):Me(e);throw new Error("Value is not a string or number.")}catch(s){const n=Ie(s)?`${s.message}. value=${JSON.stringify(e)}`:"An unknown error has occured.";throw new Error(n)}}function Ce(e){if(e=String(e),e.length>100)throw new Error("Value exceeds the maximum length of 100 characters.");const t=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(e);if(!t)return NaN;const s=parseFloat(t[1]),n=(t[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return s*ve;case"weeks":case"week":case"w":return s*Se;case"days":case"day":case"d":return s*b;case"hours":case"hour":case"hrs":case"hr":case"h":return s*S;case"minutes":case"minute":case"mins":case"min":case"m":return s*A;case"seconds":case"second":case"secs":case"sec":case"s":return s*k;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return s;default:throw new Error(`The unit ${n} was matched, but no matching case exists.`)}}function Me(e){const t=Math.abs(e);return t>=b?`${Math.round(e/b)}d`:t>=S?`${Math.round(e/S)}h`:t>=A?`${Math.round(e/A)}m`:t>=k?`${Math.round(e/k)}s`:`${e}ms`}function xe(e){const t=Math.abs(e);return t>=b?L(e,t,b,"day"):t>=S?L(e,t,S,"hour"):t>=A?L(e,t,A,"minute"):t>=k?L(e,t,k,"second"):`${e} ms`}function L(e,t,s,n){const r=t>=s*1.5;return`${Math.round(e/s)} ${n}${r?"s":""}`}function Ie(e){return typeof e=="object"&&e!==null&&"message"in e}const _e=e=>(t,s)=>(e.set(t,s),s),ne=Number.MAX_SAFE_INTEGER===void 0?9007199254740991:Number.MAX_SAFE_INTEGER,re=536870912,ie=re*2,Re=(e,t)=>s=>{const n=t.get(s);let r=n===void 0?s.size:n<ie?n+1:0;if(!s.has(r))return e(s,r);if(s.size<re){for(;s.has(r);)r=Math.floor(Math.random()*ie);return e(s,r)}if(s.size>ne)throw new Error("Congratulations, you created a collection of unique numbers which uses all available integers!");for(;s.has(r);)r=Math.floor(Math.random()*ne);return e(s,r)},oe=new WeakMap,Ne=_e(oe),U=Re(Ne,oe),Oe=e=>e.method!==void 0&&e.method==="call",Fe=e=>e.error===null&&typeof e.id=="number",le=((e,t)=>{let s=null;return()=>{if(s!==null)return s;const n=new Blob([t],{type:"application/javascript; charset=utf-8"}),r=URL.createObjectURL(n);return s=e(r),setTimeout(()=>URL.revokeObjectURL(r)),s}})(e=>{const t=new Map([[0,()=>{}]]),s=new Map([[0,()=>{}]]),n=new Map,r=new Worker(e);return r.addEventListener("message",({data:u})=>{if(Oe(u)){const{params:{timerId:a,timerType:c}}=u;if(c==="interval"){const h=t.get(a);if(typeof h=="number"){const g=n.get(h);if(g===void 0||g.timerId!==a||g.timerType!==c)throw new Error("The timer is in an undefined state.")}else if(typeof h<"u")h();else throw new Error("The timer is in an undefined state.")}else if(c==="timeout"){const h=s.get(a);if(typeof h=="number"){const g=n.get(h);if(g===void 0||g.timerId!==a||g.timerType!==c)throw new Error("The timer is in an undefined state.")}else if(typeof h<"u")h(),s.delete(a);else throw new Error("The timer is in an undefined state.")}}else if(Fe(u)){const{id:a}=u,c=n.get(a);if(c===void 0)throw new Error("The timer is in an undefined state.");const{timerId:h,timerType:g}=c;n.delete(a),g==="interval"?t.delete(h):s.delete(h)}else{const{error:{message:a}}=u;throw new Error(a)}}),{clearInterval:u=>{const a=U(n);n.set(a,{timerId:u,timerType:"interval"}),t.set(u,a),r.postMessage({id:a,method:"clear",params:{timerId:u,timerType:"interval"}})},clearTimeout:u=>{const a=U(n);n.set(a,{timerId:u,timerType:"timeout"}),s.set(u,a),r.postMessage({id:a,method:"clear",params:{timerId:u,timerType:"timeout"}})},setInterval:(u,a)=>{const c=U(t);return t.set(c,()=>{u(),typeof t.get(c)=="function"&&r.postMessage({id:null,method:"set",params:{delay:a,now:performance.now(),timerId:c,timerType:"interval"}})}),r.postMessage({id:null,method:"set",params:{delay:a,now:performance.now(),timerId:c,timerType:"interval"}}),c},setTimeout:(u,a)=>{const c=U(s);return s.set(c,u),r.postMessage({id:null,method:"set",params:{delay:a,now:performance.now(),timerId:c,timerType:"timeout"}}),c}}},`(()=>{"use strict";const e=new Map,t=new Map,r=(e,t)=>{let r,o;const i=performance.now();r=i,o=e-Math.max(0,i-t);return{expected:r+o,remainingDelay:o}},o=(e,t,r,i)=>{const s=performance.now();s>r?postMessage({id:null,method:"call",params:{timerId:t,timerType:i}}):e.set(t,setTimeout(o,r-s,e,t,r,i))};addEventListener("message",(i=>{let{data:s}=i;try{if("clear"===s.method){const{id:r,params:{timerId:o,timerType:i}}=s;if("interval"===i)(t=>{const r=e.get(t);if(void 0===r)throw new Error('There is no interval scheduled with the given id "'.concat(t,'".'));clearTimeout(r),e.delete(t)})(o),postMessage({error:null,id:r});else{if("timeout"!==i)throw new Error('The given type "'.concat(i,'" is not supported'));(e=>{const r=t.get(e);if(void 0===r)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(r),t.delete(e)})(o),postMessage({error:null,id:r})}}else{if("set"!==s.method)throw new Error('The given method "'.concat(s.method,'" is not supported'));{const{params:{delay:i,now:n,timerId:a,timerType:d}}=s;if("interval"===d)((t,i,s)=>{const{expected:n,remainingDelay:a}=r(t,s);e.set(i,setTimeout(o,a,e,i,n,"interval"))})(i,a,n);else{if("timeout"!==d)throw new Error('The given type "'.concat(d,'" is not supported'));((e,i,s)=>{const{expected:n,remainingDelay:a}=r(e,s);t.set(i,setTimeout(o,a,t,i,n,"timeout"))})(i,a,n)}}}}catch(e){postMessage({error:{message:e.message},id:s.id,result:null})}}))})();`),Be=e=>le().clearInterval(e),ae=(e,t)=>le().setInterval(e,t);function w(e,t,...s){const n=document.createElement(e);return t instanceof Node?n.append(t):typeof t=="string"?n.append(Le(t)):Array.isArray(t)?n.append(...t):(Object.assign(n,t),Object.assign(n.style,t?.style)),n.append(...s),n}function Le(e){return document.createTextNode(e)}class Ue{constructor(t){this.storage=t}download(){const t=this.storage.read();if(!t.length){alert("\u041D\u0435\u0442\u0443 \u0434\u0430\u043D\u043D\u044B\u0445 \u0434\u043B\u044F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0430.");return}const s=new Date,n=new Intl.DateTimeFormat("ru-RU",{timeZone:"UTC",timeZoneName:"short"}),r=w("table",{border:"1"}),i=w("caption"),l=w("tr",w("th","Task Type"),w("th","Estimated Rating Time"));r.append(i,l);let o=0;for(const{type:a,estimated:c}of t){o+=c;const h=w("tr",w("td",a),w("td",B(c,{long:!0})));r.append(h)}i.textContent=`Tasks ${n.format(s)} (${B(o,{long:!0})})`;const d=new Blob([r.outerHTML],{type:"text/html"});w("a",{href:URL.createObjectURL(d),download:`tryrating-com-${s.toISOString()}.html`}).click()}}const $e=".survey-meta-fields",qe=".labeled-attribute__attribute",ue={selector:".btn-success",text:"Submit Rating"},De=".modal-container.visible",V="tryrating-storage";function Ge(){return document.querySelector(De)}function ce(e){return e.split(/\s(?=\d)/).reduce((s,n)=>(s+=B(n),s),0)}const[$,H]=I([]);class We{constructor(){this.read(),console.log("tasks",$())}get values(){return $()}reset(){H([]),GM_setValue(V,$())}read(){const t=GM_getValue(V,[]);return H(t),t}write(t){H(s=>[...s,t]),GM_setValue(V,$())}}function je(){const[e,t]=I([]);function s(){const n=[],r=Array.from(document.querySelectorAll(ue.selector));for(const i of r)i instanceof HTMLButtonElement&&i.textContent===ue.text&&n.push(i);return t(n),n}return{findSubmitButtons:s,get submitButtons(){return e()}}}class Ve{taskFields=null;onChangeTaskCallback=null;get values(){return this.taskFields}onChangeTask(t){this.onChangeTaskCallback=t}watch(){const t=document.querySelector($e);if(!t)return;const s=Array.from(t.querySelectorAll(qe));if(!s.length)return;const[n,r,i]=s,l={taskType:n.textContent,requestId:r.textContent,estimatedRatingTime:i.textContent.trim()};l.requestId!==this.taskFields?.requestId&&this.onChangeTaskCallback(l),this.taskFields=l}}const[fe,de]=I(0);class He{intervalId;onEndCallback;onTickTimer(){const t=fe()-1e3;de(t),t===0&&(this.onEndCallback(),this.stop())}get time(){return fe()}onTimerEnd(t){this.onEndCallback=t}start(t){this.stop(),de(t),this.intervalId=ae(()=>this.onTickTimer(),1e3)}stop(){this.intervalId&&(Be(this.intervalId),this.intervalId=null)}}const st="",Pe=Ae('<div class="tryrating-container"><span class="counter">Time: </span><span class="timer">Tasks: '),{findSubmitButtons:he}=je(),[Ye,Ke]=I(null),q=new We,Xe=new Ue(q),P=new He;P.onTimerEnd(async()=>{const e=he();if(!e.length){console.error("submitButtons is not defined");return}e[0]?.click()});const me=new Ve;me.onChangeTask(e=>{const t=Ye();t&&t.requestId!==e.requestId&&(console.info("Current task is submitted:",t),q.write({type:t.taskType,estimated:ce(t.estimatedRatingTime)})),Ke(e),he();const s=ce(e.estimatedRatingTime);P.start(s)}),ae(()=>{me.watch(),Ge()&&GM_notification({title:"\u041E\u0442\u043A\u0440\u044B\u043B\u043E\u0441\u044C \u043C\u043E\u0434\u0430\u043B\u044C\u043D\u043E\u0435 \u043E\u043A\u043D\u043E",highlight:!0,silent:!1,timeout:5e3})},5e3),window.addEventListener("keydown",e=>{e.altKey&&e.key==="1"&&(e.preventDefault(),Xe.download()),e.altKey&&e.key==="2"&&(e.preventDefault(),confirm(`Reset data.
Are you sure?`)&&q.reset())});const ze=()=>{const e=K(()=>B(P.time,{long:!0})),t=K(()=>q.values);return(()=>{const s=Pe(),n=s.firstChild;n.firstChild;const r=n.nextSibling;return r.firstChild,W(n,e,null),W(r,()=>t().length,null),s})()};ke(()=>be(ze,{}),document.body),GM_addStyle(`.tryrating-container {  display: flex;
  align-items: center;
  flex-direction: column;
  gap: 1rem;
  text-align: center;
  position: absolute;
  z-index: 9999999;
  background: #2e2c2f;
  font-size: 1rem;
  font-weight: 600;
  color: white;
  width: 75px;
  bottom: 12%;
  padding: 4px;
}
`)})();
